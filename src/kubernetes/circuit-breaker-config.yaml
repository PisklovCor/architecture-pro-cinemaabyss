# Istio Circuit Breaker Configuration for CinemaAbyss
# DestinationRule configures circuit breaker settings for services

apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: monolith-circuit-breaker
  namespace: cinemaabyss
spec:
  host: monolith.cinemaabyss.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 10          # Maximum connections to the destination host
      http:
        http1MaxPendingRequests: 5  # Maximum pending HTTP requests to a destination host
        http2MaxRequests: 10        # Maximum number of requests to a backend
        maxRequestsPerConnection: 2 # Maximum number of requests per connection to a backend
        maxRetries: 3               # Maximum number of retries per request
    outlierDetection:
      consecutiveGatewayErrors: 3
      consecutive5xxErrors: 3
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

---

apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: movies-service-circuit-breaker
  namespace: cinemaabyss
spec:
  host: movies-service.cinemaabyss.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 10          # Maximum connections to the destination host
      http:
        http1MaxPendingRequests: 3  # Lower threshold for movies service
        http2MaxRequests: 8         # Maximum number of requests to a backend
        maxRequestsPerConnection: 2 # Maximum number of requests per connection to a backend
        maxRetries: 2               # Maximum number of retries per request
    outlierDetection:
      consecutiveGatewayErrors: 2   # Lower threshold for faster detection
      consecutive5xxErrors: 2
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 30

---

# VirtualService for managing traffic routing and timeouts
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: cinemaabyss-routes
  namespace: cinemaabyss
spec:
  hosts:
  - cinemaabyss.example.com
  gateways:
  - cinemaabyss-gateway
  http:
  - match:
    - uri:
        prefix: "/api/movies"
    route:
    - destination:
        host: movies-service.cinemaabyss.svc.cluster.local
        port:
          number: 8081
    timeout: 10s              # Request timeout
    retries:
      attempts: 3
      perTryTimeout: 3s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - uri:
        prefix: "/api/events"
    route:
    - destination:
        host: events-service.cinemaabyss.svc.cluster.local
        port:
          number: 8082
    timeout: 10s
    retries:
      attempts: 3
      perTryTimeout: 3s
      retryOn: gateway-error,connect-failure,refused-stream
  - match:
    - uri:
        prefix: "/"
    route:
    - destination:
        host: monolith.cinemaabyss.svc.cluster.local
        port:
          number: 8080
    timeout: 15s              # Longer timeout for monolith
    retries:
      attempts: 2
      perTryTimeout: 5s
      retryOn: gateway-error,connect-failure,refused-stream

---

# Gateway configuration for Istio ingress
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: cinemaabyss-gateway
  namespace: cinemaabyss
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - cinemaabyss.example.com
